---
namespace: solr-zookeeper

solr-common:
  defines: runnable
  metadata:
    private: true
  services:
    solr:
      container: solr
      port: 8983
      protocol: tcp
      host-port: 8983
  connections:
    solr-1:
      runnable: solr-zookeeper/solr-1
      service: solr
    solr-2:
      runnable: solr-zookeeper/solr-2
      service: solr
    solr-3:
      runnable: solr-zookeeper/solr-3
      service: solr
    zookeeper-1:
      runnable: solr-zookeeper/zookeeper-1
      service: server
    zookeeper-2:
      runnable: solr-zookeeper/zookeeper-2
      service: server
    zookeeper-3:
      runnable: solr-zookeeper/zookeeper-3
      service: server
  containers:
    solr:
      image: solr
      image-tag: <- `${solr-image}`
      paths:
        - <- `${volume-data}:/var/solr`
      ports:
        - 8983
  depends:
    wait-for:
      runnables:
        - solr-zookeeper/zookeeper-1
        - solr-zookeeper/zookeeper-2
        - solr-zookeeper/zookeeper-3
  files:
    solr-config:
      container: solr
      mode: 0644
      path: /opt/solr/server/solr/solr.xml
      contents: <<< files/solr.xml
  variables:
    volume-data:
      type: string
      value: <- `${monk-volume-path}/solr/soldata`
    solr-image:
      value: <- `${solr-image-tag}`
      type: string
    zk-host:
      env: ZK_HOST
      value: <- connection-hostname("zookeeper-1") ":" connection-port("zookeeper-1") "," connection-hostname("zookeeper-2") ":" connection-port("zookeeper-2") "," connection-hostname("zookeeper-3") ":" connection-port("zookeeper-3") concat-all
      type: string
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-1")
      type: string
    persistent-volume-disk-size:
      type: string
      value: 20
    persistent-volume-disk-kind:
      type: string
      value: HDD
    solr-image-tag:
      type: string
      value: latest

zookeeper-common:
  defines: runnable
  metadata:
    private: true
  readiness:
    code: |
      exec("zookeeper", "/usr/bin/bash", "-c", "echo 'ruok' | nc -w 2 localhost 2181 | grep imok") "imok" contains?
    period: 10
    initialDelay: 5
  services:
    server:
      container: zookeeper
      port: 2181
      protocol: tcp
      host-port: 2181
    peer:
      container: zookeeper
      port: 2888
      protocol: tcp
      host-port: 2888
    leader:
      container: zookeeper
      port: 3888
      protocol: tcp
      host-port: 3888
    metrics:
      container: zookeeper
      port: 7000
      protocol: tcp
      host-port: 7000
  connections:
    solr-1:
      runnable: solr-zookeeper/solr-1
      service: solr
    solr-2:
      runnable: solr-zookeeper/solr-2
      service: solr
    solr-3:
      runnable: solr-zookeeper/solr-3
      service: solr
    zookeeper-1:
      runnable: solr-zookeeper/zookeeper-1
      service: server
    zookeeper-2:
      runnable: solr-zookeeper/zookeeper-2
      service: server
    zookeeper-3:
      runnable: solr-zookeeper/zookeeper-3
      service: server
  containers:
    zookeeper:
      image: zookeeper
      image-tag: <- `${zookeeper-image}`
      paths:
        - <- `${volume-data}/data:/data`
        - <- `${volume-data}/datalog:/datalog`
      ports:
        - 2181
        - 7000
        - 2888
        - 3888
  variables:
    volume-data:
      type: string
      value: <- `${monk-volume-path}/zookeper`
    zookeeper-image:
      value: <- `${zookeeper-image-tag}`
      type: string
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: string
      value: 1
    ZOO_SERVERS:
      env: ZOO_SERVERS
      type: string
      value: <- "server.1=" connection-hostname("zookeeper-1") ":2888:3888;2181" " " "server.2=" connection-hostname("zookeeper-2") ":2888:3888;2181" " " "server.3=" connection-hostname("zookeeper-3") ":2888:3888;2181" concat-all
    ZOO_4LW_COMMANDS_WHITELIST:
      env: ZOO_4LW_COMMANDS_WHITELIST
      type: string
      value: mntr, conf, ruok
    ZOO_CFG_EXTRA:
      env: ZOO_CFG_EXTRA
      type: string
      value: metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true
    persistent-volume-disk-size:
      type: string
      value: 20
    persistent-volume-disk-kind:
      type: string
      value: HDD
    zookeeper-image-tag:
      type: string
      value: 3.8.0

solr-1:
  defines: runnable
  inherits: solr-zookeeper/solr-common
  volumes:
    solr-1:
      size: <- $persistent-volume-disk-size
      kind: <- `${persistent-volume-disk-kind}`
      path: <- `${volume-data}`
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-1")
      type: string
    volume-data:
      type: string
      value: <- `${monk-volume-path}/solr/soldata-1`

solr-2:
  defines: runnable
  inherits: solr-zookeeper/solr-common
  volumes:
    solr-2:
      size: <- $persistent-volume-disk-size
      kind: <- `${persistent-volume-disk-kind}`
      path: <- `${volume-data}`
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-2")
      type: string
    volume-data:
      type: string
      value: <- `${monk-volume-path}/solr/soldata-2`

solr-3:
  defines: runnable
  inherits: solr-zookeeper/solr-common
  volumes:
    solr-3:
      size: <- $persistent-volume-disk-size
      kind: <- `${persistent-volume-disk-kind}`
      path: <- `${volume-data}`
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-3")
      type: string
    volume-data:
      type: string
      value: <- `${monk-volume-path}/solr/soldata-3`

zookeeper-1:
  defines: runnable
  inherits: solr-zookeeper/zookeeper-common
  volumes:
    zookeper-1:
      size: <- $persistent-volume-disk-size
      kind: <- `${persistent-volume-disk-kind}`
      path: <- `${volume-data}`
  variables:
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: string
      value: 1
    volume-data:
      type: string
      value: <- `${monk-volume-path}/zookeper-1`

zookeeper-2:
  defines: runnable
  inherits: solr-zookeeper/zookeeper-common
  volumes:
    zookeper-2:
      size: <- $persistent-volume-disk-size
      kind: <- `${persistent-volume-disk-kind}`
      path: <- `${volume-data}`
  variables:
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: string
      value: 2
    volume-data:
      type: string
      value: <- `${monk-volume-path}/zookeper-2`

zookeeper-3:
  defines: runnable
  inherits: solr-zookeeper/zookeeper-common
  volumes:
    zookeper-3:
      size: <- $persistent-volume-disk-size
      kind: <- `${persistent-volume-disk-kind}`
      path: <- `${volume-data}`
  variables:
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: string
      value: 3
    volume-data:
      type: string
      value: <- `${monk-volume-path}/zookeper-3`
