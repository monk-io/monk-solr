namespace: solr-zookeeper


solr-common:
  defines: runnable
  services:
    solr:
      container: zookeeper
      port: 8983
      protocol: tcp
      host-port: 8983
  connections:
    solr-1:
      runnable: solr-zookeeper/solr-1
      service: solr
    solr-2:
      runnable: solr-zookeeper/solr-2
      service: solr
    solr-3:
      runnable: solr-zookeeper/solr-3
      service: solr 
    zookeeper-1:
      runnable: solr-zookeeper/zookeeper-1
      service: zookeeper
    zookeeper-2:
      runnable: solr-zookeeper/zookeeper-2
      service: zookeeper
    zookeeper-3:
      runnable: solr-zookeeper/zookeeper-3
      service: zookeeper                                         
  containers:
    defines: containers
    solr:
      image:  docker.io/solr
      image-tag: <- `${solr-image}`
      user: "8983"
      ports:
        - 8983:8983
      paths:
        - <- `${volume-data}:/var/solr`
  # depends:
  #   wait-for:
  #     runnables:
  #       - solr-zookeeper/zookeeper-1 
  #       - solr-zookeeper/zookeeper-2
  #       - solr-zookeeper/zookeeper-3
  files:
    solr-config:
      container: solr
      mode: 0644
      path: /opt/solr/server/solr/solr.xml
      contents: <<< files/solr.xml
  variables:
    volume-data:
      type: string
      value: <- `${monk-volume-path}/solr/soldata`  
    solr-image:
      value: <- $solr-image-tag
      type: string
    zk-host:
      env: ZK_HOST
      value: <- connection-hostname("zookeeper-1") ":2181," connection-hostname("zookeeper-2") ":2181," connection-hostname("zookeeper-3") ":2181" concat-all
      type: string
    solr-host-1:
      env: SOLR_HOST
      value: <- connection-hostname("solr-1")
      type: string     


zookeeper-common:
  defines: runnable
  # readiness:
  #     code: |
  #         exec("zookeeper", "/usr/bin/bash", "-c", "echo 'ruok' | nc -w 2 localhost 2181 | grep imok") "imok" contains?
  #     period: 10
  #     initialDelay: 5  
  services:
    zookeeper:
      container: zookeeper
      port: 2181
      protocol: tcp
      host-port: 2181
  connections:
    solr-1:
      runnable: solr-zookeeper/solr-1
      service: solr
    solr-2:
      runnable: solr-zookeeper/solr-2
      service: solr
    solr-3:
      runnable: solr-zookeeper/solr-3
      service: solr 
    zookeeper-1:
      runnable: solr-zookeeper/zookeeper-1
      service: zookeeper
    zookeeper-2:
      runnable: solr-zookeeper/zookeeper-2
      service: zookeeper
    zookeeper-3:
      runnable: solr-zookeeper/zookeeper-3
      service: zookeeper       
  containers:
    defines: containers
    zookeeper:
      image:  docker.io/zookeeper
      image-tag: <- `${zookeeper-image}`
      paths:
        - <- `${volume-data}/data:/data`
        - <- `${volume-data}/datalog:/datalog`
      ports:
        - 2181:2181
        - 7000:7000 
        # - 2181
        # - 7000
        - 2888
        - 3888
  variables:
    volume-data:
      type: string
      value: <- `${monk-volume-path}/zookeper`  
    zookeeper-image:
      value: <- $zookeeper-image-tag
      type: string
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: int
      value: 1
    ZOO_SERVERS:
      env: ZOO_SERVERS
      type: string
      value: <- "server.1=" connection-hostname("zookeeper-1") ":2888:3888;2181" " " "server.2=" connection-hostname("zookeeper-2") ":2888:3888;2181" " " concat-all
      # value: <- "server.1=" connection-hostname("zookeeper-1") ":2888:3888;2181" " " "server.2=" connection-hostname("zookeeper-2") ":2888:3888;2181" " " "server.3=" connection-hostname("zookeeper-3") ":2888:3888;2181" concat-all
    ZOO_4LW_COMMANDS_WHITELIST:
      env: ZOO_4LW_COMMANDS_WHITELIST
      type: string
      value: "mntr, conf, ruok"
    ZOO_CFG_EXTRA:
      env: ZOO_CFG_EXTRA
      type: string
      value: "metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true" 
    zk-host-container:
      env: zookeeper_host_containers
      value: <- get-hostname("solr-zookeeper/zookeeper-1", "zookeeper") split(".dns.podman") join("") ":2181," get-hostname("solr-zookeeper/zookeeper-2", "zookeeper") split(".dns.podman") join("") ":2181," get-hostname("solr-zookeeper/zookeeper-3", "zookeeper") split(".dns.podman") join("") ":2181" concat-all
      type: string

solr-1:
  defines: runnable
  inherits: ./solr-common
  volumes:
    solr-1:
      size: <- $persistent-volume-disk-size
      kind: <- $persistent-volume-disk-kind
      path: <- $volume-data
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-1")
      type: string

solr-2:
  defines: runnable
  inherits: ./solr-common
  volumes:
    solr-2:
      size: <- $persistent-volume-disk-size
      kind: <- $persistent-volume-disk-kind
      path: <- $volume-data
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-2")
      type: string

solr-3:
  defines: runnable
  inherits: ./solr-common
  volumes:
    solr-3:
      size: <- $persistent-volume-disk-size
      kind: <- $persistent-volume-disk-kind
      path: <- $volume-data
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-3")
      type: string

zookeeper-1:
  defines: runnable
  inherits: ./zookeeper-common
  volumes:
    zookeper-1:
      size: <- $persistent-volume-disk-size
      kind: <- $persistent-volume-disk-kind
      path: <- $volume-data  
  variables:
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: int
      value: 1

zookeeper-2:
  defines: runnable
  inherits: ./zookeeper-common
  volumes:
    zookeper-2:
      size: <- $persistent-volume-disk-size
      kind: <- $persistent-volume-disk-kind
      path: <- $volume-data 
  variables:
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: int
      value: 2

zookeeper-3:
  defines: runnable
  inherits: ./zookeeper-common
  volumes:
    zookeper-3:
      size: <- $persistent-volume-disk-size
      kind: <- $persistent-volume-disk-kind
      path: <- $volume-data  
  variables:
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: int
      value: 3


# telnet-1:
#   defines: runnable
#   connections:
#     solr-1:
#       runnable: solr-zookeeper/solr-1
#       service: solr
#     solr-2:
#       runnable: solr-zookeeper/solr-2
#       service: solr
#     solr-3:
#       runnable: solr-zookeeper/solr-3
#       service: solr 
#     zookeeper-1:
#       runnable: solr-zookeeper/zookeeper-1
#       service: zookeeper
#     zookeeper-2:
#       runnable: solr-zookeeper/zookeeper-2
#       service: zookeeper
#     zookeeper-3:
#       runnable: solr-zookeeper/zookeeper-3
#       service: zookeeper
#   containers:
#     defines: containers
#     telnet:
#       image: praqma/network-multitool:latest
#       ports:
#         - 1180
#         - 11443 
#   variables:
#     master-node-ip-address:
#       env: MASTER_NODE_IP_ADRESS
#       value: <- peer-ip-address("solr-zookeeper/zookeeper-3")
#       type: string
#     node-public-ip-address:
#       env: NODE_PUBLIC_IP_ADRESS
#       value: <- ip-address-public
#       type: string
#     zk-host-svc:
#       env: ZK_HOST
#       value: <- connection-hostname("zookeeper-1") ":2181," connection-hostname("zookeeper-2") ":2181," connection-hostname("zookeeper-3") ":2181" concat-all
#       type: string
#     solr-host:
#       env: SOLR_HOST
#       value: <- connection-hostname("solr-1")
#       type: string
#     zk-host-container:
#       env: ZK_HOST
#       value: <- get-hostname("solr-zookeeper/zookeeper-1", "zookeeper") split(".dns.podman") join("") ":2181," get-hostname("solr-zookeeper/zookeeper-2", "zookeeper") split(".dns.podman") join("") ":2181," get-hostname("solr-zookeeper/zookeeper-3", "zookeeper") split(".dns.podman") join("") ":2181" concat-all
#       type: string
#     ZOO_SERVERS:
#       env: ZOO_SERVERS
#       type: string
#       value: <- "server.1=" connection-hostname("zookeeper-1") ":2888:3888;2181" " " "server.2=" connection-hostname("zookeeper-2") ":2888:3888;2181" " " "server.3=" connection-hostname("zookeeper-3") ":2888:3888;2181" concat-all
