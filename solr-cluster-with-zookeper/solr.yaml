---
namespace: solr-zookeeper

solr-common:
  defines: runnable
  metadata:
    private: true
  services:
    solr:
      container: solr
      port: 8983
      protocol: tcp
      host-port: 8983
  connections:
    solr-1:
      runnable: solr-zookeeper/solr-1
      service: solr
    solr-2:
      runnable: solr-zookeeper/solr-2
      service: solr
    solr-3:
      runnable: solr-zookeeper/solr-3
      service: solr
    zookeeper:
      runnable: solr-zookeeper/zookeeper
      service: server    
  containers:
    solr:
      image: solr
      image-tag: <- `${solr-image}`
      paths:
        - <- `${monk-volume-path}/solr/soldata:/var/solr`
      ports:
        - 8983:8983
  depends:
    wait-for:
      runnables:
        - solr-zookeeper/zookeeper
  files:
    solr-config:
      container: solr
      mode: 0644
      path: /opt/solr/server/solr/solr.xml
      contents: <<< files/solr.xml
  variables:
    solr-image:
      value: <- `${solr-image-tag}`
      type: string
    zk-host:
      env: ZK_HOST
      value: <- connection-hostname("zookeeper") ":" connection-port("zookeeper")  concat-all
      type: string
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-1")
      type: string
    solr-image-tag:
      type: string
      value: latest

zookeeper-base:
  defines: runnable
  services:
    server:
      container: zookeeper
      port: 2181
      protocol: tcp
    peer:
      container: zookeeper
      port: 2888
      protocol: tcp
    leader:
      container: zookeeper
      port: 3888
      protocol: tcp
    metrics:
      container: zookeeper
      port: 7000
      protocol: tcp
  connections:
    solr-1:
      runnable: solr-zookeeper/solr-1
      service: solr
    solr-2:
      runnable: solr-zookeeper/solr-2
      service: solr
    solr-3:
      runnable: solr-zookeeper/solr-3
      service: solr
    zookeeper:
      runnable: solr-zookeeper/zookeeper
      service: server  
  metadata:
    private: true
  readiness:
    code: |
      exec("zookeeper", "/usr/bin/bash", "-c", "echo 'ruok' | nc -w 2 localhost 2181 | grep imok") "imok" contains?
    period: 10
    initialDelay: 5
  containers:
    zookeeper:
      image: zookeeper
      image-tag: <- `${zookeeper-image}`
      paths:
        - <- `${monk-volume-path}/zookeper/data:/data`
        - <- `${monk-volume-path}/zookeper/datalog:/datalog`
      ports:
        - 2181:2181
        - 7000:7000
        - 2888:2888
        - 3888:3888
  variables:
    zookeeper-image:
      value: <- `${zookeeper-image-tag}`
      type: string
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: string
      value: 1
    ZOO_SERVERS:
      env: ZOO_SERVERS
      type: string
      value: <- "server.1=" connection-hostname("zookeeper") ":2888:3888;2181" concat-all
    ZOO_4LW_COMMANDS_WHITELIST:
      env: ZOO_4LW_COMMANDS_WHITELIST
      type: string
      value: mntr, conf, ruok
    ZOO_CFG_EXTRA:
      env: ZOO_CFG_EXTRA
      type: string
      value: metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true
    zookeeper-image-tag:
      type: string
      value: 3.8.0

solr-1:
  defines: runnable
  inherits: solr-zookeeper/solr-common  
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-1")
      type: string    

solr-2:
  defines: runnable
  inherits: solr-zookeeper/solr-common
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-2")
      type: string 

solr-3:
  defines: runnable
  inherits: solr-zookeeper/solr-common
  variables:
    solr-host:
      env: SOLR_HOST
      value: <- connection-hostname("solr-3")
      type: string

zookeeper:
  defines: runnable
  inherits: solr-zookeeper/zookeeper-base
  variables:
    ZOO_MY_ID:
      env: ZOO_MY_ID
      type: string
      value: 1    
